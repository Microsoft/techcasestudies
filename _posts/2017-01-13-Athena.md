---
layout: post
title:  "Using Power BI to provide reports for Athena Intelligence"
author: "Tim Reilly, Heather Shapiro,Mostafa Elzoghbi"
author-link: "#"
#author-image: "{{ site.baseurl }}/images/authors/photo.jpg"
date:   2017-1-13 
categories: [Power BI Embedded]
color: "blue"
#image: "{{ site.baseurl }}/images/Athena/AthenaWebsite.PNG" #should be ~350px tall
excerpt: Microsoft teamed up with Athena Intelligence to bring Power BI analytics to their customers interested in aggregated water usage data about the State of California to an unprecedented level of detail.
verticals: Environment
language: English
---

![Athena Intelligence website](/images/Athena/AthenaWebsite.PNG) 

We set out to bring Power BI Embedded analytics capabilities into a brand new ASP.NET web application for Athena Intelligence. 
Athena Intelligence is a data processing and data visualization platform for the data of land, food, water, and energy for the State of California.

Core team: 

- David Sypnieski - Founder, CEO, Athena Intelligence, Inc.
- Kevin Day - Software Engineer, Athena Intelligence, Inc.
- Tim Reilly ([@timmyreilly ](https://twitter.com/timmyreilly))- Technical Evangelist, Microsoft
- Heather Shapiro ([@microheather ](https://twitter.com/microheather))- Technical Evangelist, Microsoft
- Mostafa Elzoghbi ([@MostafaElzoghbi ](https://twitter.com/MostafaElzoghbi)) â€“ Senior Technical Evangelist, Microsoft


Our solution required the creation of an interactive dashboard for Athena Intelligence customers in research and private industries to view aggregated water usage data in the State of California.
This involved the creation of Power BI reports that accessed a PostgreSQL database.
These reports were later integrated into a new ASP.NET MVC 4.5 web application that runs in Microsoft Azure with a SQL Server 2016 Database to support user authentication.  

## Customer profile ##

[Athena Intelligence, Inc.](http://project-athena.com) provides data services from the vast amounts of public data that we process and a business intelligence application that incorporates additional private data sources. 
Their business intelligence application makes it easy for companies and organizations managing food, water, or energy production to analyze the risks and opportunities in their supply chain by combining natural resource, processing/manufacturing, and production practice data. By enabling the utilization of existing data and allowing for easier capture of new data, we unlock the value in the supply chain's data and make it simple for companies to manage their resources more intelligently.


## Problem statement ##

Athena Intelligence provides data services from the vast amounts of public data that we process and a business intelligence application that incorporates additional private data sources. 
Their business intelligence application makes it easy for companies and organizations managing food, water, or energy production to analyze the risks and opportunities in their supply chain by combining natural resource, processing/manufacturing, and production practice data. By enabling the utilization of existing data and allowing for easier capture of new data, we unlock the value in the supply chain's data and make it simple for companies to manage their resources more intelligently.

Athena Intelligence is looking to scale their applications using Power BI embedded and Azure. They currently have a manual workflow for building charts but are seeing redundancies in workflows and would like to start leveraging the analytics, visualization, and authorization features of Power BI and Power BI Embedded. The Athena Intelligence platform will be used by external customers from farming industry to agricultural research.  

We will connect to Athena's existing PostgreSQL databases to import data into embedded Power BI reports to bring statistics about water usage and distribution across the state of California to their customers. These dashboards will be integrated into a new ASP.NET web application and connected to their existing website. 

## Key Technologies Used 
- [Power Bi Embedded](https://azure.microsoft.com/en-us/services/power-bi-embedded/) 
- [Power Bi Desktop](https://powerbi.microsoft.com/en-us/desktop/) 
- [Azure SQL Database](https://azure.microsoft.com/en-us/services/sql-database/) 
- [ASP.NET MVC](https://www.asp.net/mvc) 
- [Azure App Services](https://azure.microsoft.com/en-us/services/app-service/)
   - [Deployment Slots](https://docs.microsoft.com/en-us/azure/app-service-web/web-sites-staged-publishing) 


## Solutions, steps, and delivery ##


1. [Connect to Athena data in PostgreSQL DBs in Azure IaaS](#1-connect-to-athena-data-in-postgresql-dbs-in-azure-iaas).
2. [Build a report using Power BI desktop](#2-create-a-report-in-power-bi-desktop).
3. [Deploy a report to Power BI Embedded in Azure and Upload Reports](#3-set-up-power-bi-embedded-workspace-in-microsoft-azure-and-upload-reports).
4. [Integrate PBIE reports into an ASP.NET MVC web application and authorize users](#4-embed-report-into-existing-aspnet-mvc-application-and-authorize-users-for-specific-reports).
5. [Use Azure SQL and Azure Web Apps to deploy application](#5-use-azure-sql-and-azure-web-apps-to-deploy-application). 

-----
### 1. Connect to Athena Data in PostgreSQL DBs In Azure IaaS 

Two factors limited our ability to use direct query in our reports. First, the complicated nature of the data and the number of tables/databases already supported would have taken to long to convert to Azure SQL. Second, features of Athena's data platform are dependent on shapefiles that are natively supported on PostgreSQL. Shapefile support is available as a plugin for SQL Server, but was beyond the scope of our working period. Here's a peek at the types of queries Athena generated in Power Bi Desktop: 

The data they're aggregating is highly unstructured, but iterating with Power Bi helped them connect things they found difficulty assessing previously.

Here is a depiction of the architecture employed:
![architecture](/images/Athena/Architecture.JPG)

### 2. Create a report in Power BI Desktop

After connecting the PostgreSQL DB into Power Bi Embedded. Reports were created for the three different users of Athena's data platform. The three reports are: Generic, Food, and Utility. 

Here's a look at the Generic Report: 

PUT IN ATHENA REPORT IN POWER BI FROM DAVID 

Each of these reports represent a different user of the product and in the future will be customized per customer demand. 

Here's a look at the Food Industry Report: 



### 3. Set up Power BI Embedded workspace in Microsoft Azure and Upload Reports

By identifying users we were able to efficiently create isolation from reports using workspaces. We created workspaces that would serve reports for Utility companies, Food/Agriculture industries, generic research, and a final one for test/samples.

Here's what it look like in the dashboard: 
![3 Workspaces for 3 customers](/images/Athena/Workspaces.PNG)

There are several methods to publish a report in a Power BI Embedded workspace:
- Using the one provided in the sample app: [Sample app](https://github.com/Azure-Samples/power-bi-embedded-integrate-report-into-web-app/)
- Using the Power BI command line tool: [Power BI Command Line Tool](https://github.com/Microsoft/PowerBI-Cli)

We used the command line tool to publish our reports in the workspace. Below are steps and screenshots of the process:
- First we had to install [node.js](https://nodejs.org/en/).
- Then we installed a Power BI node.js package using the command prompt: `npm install powerbi-cli -g`

![Install node.js package](/images/Athena/Nodejs-PowerBI.PNG)

- And finally, we used the command "powerbi - import" as listed in the screenshot below to add the Power BI Desktop reports to the Azure Workspace Collection:

![Power BI Command](/images/Athena/Powerbi-nodejs.PNG)

We documented these steps in the PoC Readme for easy replication for Athena. 


### 4. Embed report into existing ASP.NET MVC application and authorize users for specific reports

The application builds off of the sample provided by the Power Bi embedded team found here: [Embed Sample](https://github.com/Azure-Samples/power-bi-embedded-integrate-report-into-web-app)

We began by setting up a new PowerBIController within the existing web application.  Through this controller we are able to limit access to the RitterIM internal report.  In code, we create an embed token using:

`var embedToken = PowerBIToken.CreateReportEmbedToken(this.workspaceCollection, this.workspaceId, report.Id);` 

This allows us to view the embedded report within the existing website:

![Athena Power Bi Embedded](/images/Athena/ReportPage.PNG)

With this first report integrated we needed to expand the web application to allow registration and login capabilities. 
Then we needed to grant specific users access to specific reports.


In order to give users access to the app, we added in the Identity authentication framework to allow users to login. 

We set up a SQL database with user information created from the Identity package. When users sign up on the website, they are asked which customer profile they fit better, ie. are they part of a Utility company, Food/Agriculture industru,  or doing generic research.

Depending on their selection, we only allow users to view this specific report. This is done by only displaying a report that matches the category that they select. Through Identity, the user is associated with the category. This category is then compared to the report names, and only the reports in the workspace that contain that category will be displayed.

### 5. Use Azure SQL and Azure Web Apps to deploy application

Now that we have a working application we need to deploy the web app to Azure with staging capabilities for easy testing and deployment. 

We used Azure Web Apps with a SQL Server instance to support the user authentication/login. 

To make ongoing development easy we've created two Databases one for testing and one for production. 
Accordingly we created a staging slot for the application that connects to the test database via a Slot Connection string: 

Here's what this looks like in the Azure Dashboard:  

![Athena Web App Staging](/images/Athena/stagingslots.PNG)

This staging slot is connected to a private Git repository, so as changes are committed the developer is able to check them in staging before hitting swap to move the new application into production. 

##  End customer example  ##

[![Athena Intelligence Dashboard Tour](/images/Athena/AthenaDashboardVideo.PNG)](https://www.youtube.com/watch?v=YKUhFQRRwaM)

## General lessons ##

Staging slots in Azure - connection strings 

Authentication using Identity
- Restricting workspaces to users based on their registration- they did not need row level security just report filtering

County data issues with reports

Visual studio nuget versioning

Creating a SQL database that deploys to azure - visual studio?

## Implementing the Power BI SDK into existing ASP.NET MVC 5 site:

Staging Slots in Azure or Authentication using Identity? 



## Additional resources ##

